---
  - hosts: 127.0.0.1
    connection: local
    become: no
    vars_files:
      - environment.yml
    tasks:
      - name: Get VM Names
        community.vmware.vmware_vm_info:
          hostname: '{{ vchostname }}'
          username: '{{ vcusername }}'
          password: '{{ vcpassword }}'
          validate_certs: no
        delegate_to: localhost
        register: vm_info
      
      - name: Validate vm_names variable
        set_fact:
          l2_vms: "{{ vm_info.virtual_machines | reject('search','vCLS') | selectattr('guest_name', 'defined') | map(attribute='guest_name') }}"

      - name: Identify Powered On VMs 
        set_fact:
          powered_on_vms: "{{ vm_info.virtual_machines | reject('search','vCLS') | selectattr('power_state', 'match', 'poweredOn') | map(attribute='guest_name') }}"

      - name: shutdown guest VMs
        community.vmware.vmware_guest_powerstate:
          hostname: '{{ vchostname }}'
          username: '{{ vcusername }}'
          password: '{{ vcpassword }}'
          name: '{{ item }}'
          validate_certs: no
          state: shutdown-guest
          state_change_timeout: 200
        delegate_to: localhost
        with_items: '{{ powered_on_vms }}'
        ignore_errors: yes

      - name: determine which VMs are Still powered On
        set_fact:
          still_on_vms: "{{ vm_info.virtual_machines | reject('search','vCLS') | selectattr('power_state', 'match', 'poweredOn') | map(attribute='guest_name') }}"
      
      - name: power off remaining VMs
        community.vmware.vmware_guest_powerstate:
          hostname: '{{ vchostname }}'
          username: '{{ vcusername }}'
          password: '{{ vcpassword }}'
          name: '{{ item }}'
          validate_certs: no
          state: powered-off
          state_change_timeout: 200
        delegate_to: localhost
        with_items: '{{ still_on_vms }}'
        ignore_errors: yes

      - name: Export L2 VMs to scratch drive as OVF
        community.vmware.vmware_export_ovf:
          hostname: '{{ vchostname }}'
          username: '{{ vcusername }}'
          password: '{{ vcpassword }}'
          name: '{{ item }}'
          export_dir: /scratch/
          validate_certs: no
        delegate_to: localhost
        with_items: '{{ l2_vms }}'
        ignore_errors: yes