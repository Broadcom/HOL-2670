---
  - hosts: 127.0.0.1
    connection: local
    become: no
    vars_files:
      - environment.yml
    tasks:
      
      - name: shutdown guest VMs
        community.vmware.vmware_guest_powerstate:
          hostname: '{{ vc_hostname }}'
          username: '{{ vc_username }}'
          password: '{{ vc_password }}'
          name: '{{ item }}'
          validate_certs: no
          state: shutdown-guest
          state_change_timeout: 200
        delegate_to: localhost
        with_items: '{{ vm_name }}'
        ignore_errors: yes

      - name: power off remaining VMs
        community.vmware.vmware_guest_powerstate:
          hostname: '{{ vc_hostname }}'
          username: '{{ vc_username }}'
          password: '{{ vc_password }}'
          name: '{{ item }}'
          validate_certs: no
          state: powered-off
          state_change_timeout: 200
        delegate_to: localhost
        with_items: '{{ vm_name }}'
        ignore_errors: yes

      - name: Export L2 VMs to scratch drive as OVF
        community.vmware.vmware_export_ovf:
          hostname: '{{ vc_hostname }}'
          username: '{{ vc_username }}'
          password: '{{ vc_password }}'
          name: '{{ item }}'
          export_dir: '{{ ova_path }}'
          validate_certs: no
        delegate_to: localhost
        with_items: '{{ vm_name }}'
        ignore_errors: yes